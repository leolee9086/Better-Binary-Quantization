# 召回率测试文档

## 概述

本目录包含针对不同嵌入引擎维度的量化检索召回率测试。这些测试用于评估二值量化在不同维度向量上的检索效果。

## 测试文件结构

### 1. 通用工具文件
- `recall-common.ts` - 包含所有维度测试的通用函数和配置

### 2. 单维度测试文件
- `recall-384d.test.ts` - 384维向量测试（BERT、RoBERTa等）
- `recall-768d.test.ts` - 768维向量测试（BERT-large、RoBERTa-large等）
- `recall-1024d.test.ts` - 1024维向量测试（一些大型模型）
- `recall-1536d.test.ts` - 1536维向量测试（更大型模型）

### 3. 综合测试文件
- `recall-all-dimensions.test.ts` - 所有维度的综合测试和对比

## 测试配置

### 支持的维度
- **384d**: BERT、RoBERTa等模型的常见维度
- **768d**: BERT-large、RoBERTa-large等模型的常见维度
- **1024d**: 一些大型模型的维度
- **1536d**: 更大型模型的维度

### 量化配置
每个维度都测试以下配置：
- **1位查询 + 1位索引**: 最高压缩比，召回率较低
- **4位查询 + 1位索引**: 平衡配置，召回率适中
- **8位查询 + 1位索引**: 高质量配置，召回率较高
- **超采样4位查询**: 4位查询+超采样策略，提高召回率

### 召回率阈值
根据维度不同，设置不同的召回率阈值：

| 维度 | 1位查询 | 4位查询 | 8位查询 | 超采样 |
|------|---------|---------|---------|--------|
| 384d | 0.60 | 0.75 | 0.85 | 0.80 |
| 768d | 0.55 | 0.70 | 0.80 | 0.75 |
| 1024d | 0.50 | 0.65 | 0.75 | 0.70 |
| 1536d | 0.45 | 0.60 | 0.70 | 0.65 |

## 运行测试

### 运行单个维度测试
```bash
# 运行384维测试
pnpm test tests/recall-384d.test.ts

# 运行768维测试
pnpm test tests/recall-768d.test.ts

# 运行1024维测试
pnpm test tests/recall-1024d.test.ts

# 运行1536维测试
pnpm test tests/recall-1536d.test.ts
```

### 运行所有维度测试
```bash
# 运行综合测试（包含所有维度和对比）
pnpm test tests/recall-all-dimensions.test.ts
```

### 运行所有召回率测试
```bash
# 运行所有以recall开头的测试
pnpm test tests/recall-*.test.ts
```

## 测试结果解读

### 召回率指标
- **recall@K**: 量化检索结果中包含真实最近邻的比例
- **avgRecall**: 所有查询的平均召回率
- **阈值**: 每个配置的最低召回率要求

### 性能趋势
1. **维度影响**: 高维度通常需要更高的量化位数来维持召回率
2. **量化位数**: 更高的查询位数通常提供更好的召回率
3. **超采样**: 超采样策略能显著提高召回率，但增加计算开销

### 典型结果
根据测试结果，典型表现如下：
- **1位查询**: 召回率 0.45-0.60，适合对精度要求不高的场景
- **4位查询**: 召回率 0.60-0.75，平衡性能和精度的选择
- **超采样**: 召回率 0.65-1.00，最高精度的选择

## 数据集配置

### 数据集大小
- **Base向量**: 1000个向量
- **Query向量**: 20个查询向量
- **TopK**: 10个最近邻

### 向量生成
- 使用固定的随机种子确保结果可重现
- 向量经过归一化处理
- 使用余弦相似性作为相似性度量

## 扩展测试

### 添加新维度
1. 在 `recall-common.ts` 中添加新配置到 `RECALL_TEST_CONFIGS`
2. 创建对应的测试文件（可选）
3. 更新综合测试文件

### 修改测试参数
- 调整召回率阈值
- 修改数据集大小
- 更改量化器配置（lambda、iters等）

## 注意事项

1. **测试时间**: 高维度测试需要更长时间，特别是1536维
2. **内存使用**: 大数据集和高维度会消耗较多内存
3. **结果稳定性**: 使用固定种子确保结果可重现
4. **阈值设置**: 阈值基于经验设置，可根据实际需求调整

## 故障排除

### 常见问题
1. **内存不足**: 减少数据集大小或降低维度
2. **测试超时**: 增加测试超时时间或减少迭代次数
3. **召回率过低**: 检查量化器配置或调整阈值

### 调试技巧
- 查看详细的召回率输出
- 检查数据集验证结果
- 对比不同配置的性能差异 